#!/bin/bash
#
# Kubemark Management Script
# Usage: ./kubemark-cluster <command> [options]

set -euo pipefail

NAMESPACE="kubemark"
KUBEMARK_VERSION="${KUBEMARK_VERSION:-v1.28.0}"
KIND_CLUSTER_NAME="kubemark-host"

check_kubectl() {
    if ! command -v kubectl &> /dev/null; then
        echo "ERROR: kubectl is not installed"
        exit 1
    fi
}

check_kind() {
    if ! command -v kind &> /dev/null; then
        echo "ERROR: kind is not installed"
        echo ""
        echo "Install with:"
        echo "  macOS:   brew install kind"
        echo "  Linux:   curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64"
        echo "           chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind"
        exit 1
    fi
}

# Ensure kind cluster exists and switch context to it
ensure_kind_cluster() {
    check_kind
    check_kubectl
    
    # Check if kind cluster exists
    if ! kind get clusters 2>/dev/null | grep -q "^${KIND_CLUSTER_NAME}$"; then
        echo "Creating kind cluster: $KIND_CLUSTER_NAME"
        kind create cluster --name "$KIND_CLUSTER_NAME" --wait 5m
        echo "✓ Kind cluster created"
    else
        echo "Kind cluster $KIND_CLUSTER_NAME already exists"
    fi
    
    # Switch to the kind cluster context
    kubectl config use-context "kind-${KIND_CLUSTER_NAME}" 2>/dev/null || {
        echo "Warning: Could not switch to kind cluster context"
        echo "Current contexts:"
        kubectl config get-contexts
        echo ""
        echo "Trying to use kind cluster directly..."
    }
    
    # Verify we can connect
    if kubectl cluster-info &>/dev/null; then
        echo "✓ Connected to kind cluster: $KIND_CLUSTER_NAME"
    else
        echo "Warning: Cannot connect to kind cluster. Please check:"
        echo "  kubectl config get-contexts"
        echo "  kubectl config use-context kind-${KIND_CLUSTER_NAME}"
    fi
}

cmd_setup() {
    # Ensure kind cluster exists first
    ensure_kind_cluster
    
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo "Setting up Kubemark namespace and secrets"
    echo "════════════════════════════════════════════════════════════════"
    
    if ! kubectl get namespace "$NAMESPACE" &>/dev/null; then
        echo "Creating namespace: $NAMESPACE"
        kubectl create namespace "$NAMESPACE"
    else
        echo "Namespace $NAMESPACE already exists"
    fi
    
    if ! kubectl get secret kubeconfig -n "$NAMESPACE" &>/dev/null; then
        echo "Creating kubeconfig secret..."
        # Get kubeconfig from the kind cluster
        TEMP_KUBECONFIG=$(mktemp)
        kubectl config view --minify --flatten > "$TEMP_KUBECONFIG"
        
        kubectl create secret generic kubeconfig \
            --namespace "$NAMESPACE" \
            --from-file=kubeconfig="$TEMP_KUBECONFIG" \
            --dry-run=client -o yaml | kubectl apply -f -
        
        rm -f "$TEMP_KUBECONFIG"
        echo "✓ Kubeconfig secret created"
    else
        echo "Kubeconfig secret already exists"
    fi
    
    echo ""
    echo "✓ Setup complete"
    echo ""
    echo "Kind cluster '$KIND_CLUSTER_NAME' is ready for Kubemark"
    echo "You can now create hollow nodes with: $0 create [NODE_COUNT]"
}

cmd_create() {
    local NODE_COUNT="${1:-10}"
    
    check_kubectl
    
    # Ensure kind cluster exists
    ensure_kind_cluster
    
    echo "════════════════════════════════════════════════════════════════"
    echo "Creating $NODE_COUNT Kubemark hollow nodes"
    echo "Kubemark version: $KUBEMARK_VERSION"
    echo "════════════════════════════════════════════════════════════════"
    
    if ! kubectl get namespace "$NAMESPACE" &>/dev/null; then
        echo "ERROR: Namespace $NAMESPACE does not exist"
        echo "Please run: $0 setup"
        exit 1
    fi
    
    if ! kubectl get secret kubeconfig -n "$NAMESPACE" &>/dev/null; then
        echo "ERROR: kubeconfig secret does not exist"
        echo "Please run: $0 setup"
        exit 1
    fi
    
    cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hollow-nodes
  namespace: $NAMESPACE
spec:
  replicas: $NODE_COUNT
  selector:
    matchLabels:
      name: hollow-node
  template:
    metadata:
      labels:
        name: hollow-node
    spec:
      containers:
      - name: hollow-kubelet
        image: registry.k8s.io/kubemark:$KUBEMARK_VERSION
        args:
        - --morph=kubelet
        - --name=\$(NODE_NAME)
        - --kubeconfig=/kubeconfig/kubeconfig
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - name: kubeconfig
          mountPath: /kubeconfig
          readOnly: true
        resources:
          requests:
            cpu: 20m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 100Mi
      volumes:
      - name: kubeconfig
        secret:
          secretName: kubeconfig
EOF

    echo ""
    echo "✓ Hollow node deployment created with $NODE_COUNT replicas"
    echo ""
    echo "Waiting for nodes to register..."
    sleep 5
    
    kubectl wait --for=condition=ready pod -l name=hollow-node -n "$NAMESPACE" --timeout=300s || true
    
    echo ""
    echo "Hollow nodes status:"
    kubectl get pods -n "$NAMESPACE" -l name=hollow-node
}

cmd_verify() {
    check_kubectl
    
    echo "════════════════════════════════════════════════════════════════"
    echo "Verifying Kubemark hollow nodes"
    echo "════════════════════════════════════════════════════════════════"
    
    if ! kubectl get namespace "$NAMESPACE" &>/dev/null; then
        echo "Namespace $NAMESPACE does not exist"
        exit 1
    fi
    
    pod_count=$(kubectl get pods -n "$NAMESPACE" -l name=hollow-node --no-headers 2>/dev/null | wc -l | tr -d ' ')
    node_count=$(kubectl get nodes --no-headers 2>/dev/null | grep -i hollow | wc -l | tr -d ' ')
    
    echo ""
    echo "Pods: $pod_count"
    echo "Nodes: $node_count"
    echo ""
    
    if [ "$pod_count" -gt 0 ]; then
        echo "Pod status:"
        kubectl get pods -n "$NAMESPACE" -l name=hollow-node
    fi
}

cmd_cleanup() {
    local DELETE_KIND="${1:-false}"
    
    check_kubectl
    
    # Switch to the kind cluster if it exists
    if kind get clusters 2>/dev/null | grep -q "^${KIND_CLUSTER_NAME}$"; then
        kubectl config use-context "kind-${KIND_CLUSTER_NAME}" 2>/dev/null || true
    fi
    
    echo "════════════════════════════════════════════════════════════════"
    echo "Cleaning up Kubemark hollow nodes"
    echo "════════════════════════════════════════════════════════════════"
    
    if kubectl get deployment hollow-nodes -n "$NAMESPACE" &>/dev/null; then
        echo "Deleting hollow-nodes deployment..."
        kubectl delete deployment hollow-nodes -n "$NAMESPACE"
        echo "✓ Deployment deleted"
    else
        echo "No hollow-nodes deployment found"
    fi
    
    # Optionally delete the kind cluster
    if [ "$DELETE_KIND" = "true" ] || [ "$DELETE_KIND" = "yes" ]; then
        echo ""
        echo "Deleting kind cluster: $KIND_CLUSTER_NAME"
        if kind delete cluster --name "$KIND_CLUSTER_NAME" 2>/dev/null; then
            echo "✓ Kind cluster deleted"
        else
            echo "✗ Failed to delete kind cluster (may not exist)"
        fi
    fi
}

cmd_scale() {
    local NODE_COUNT="${1:-}"
    
    check_kubectl
    
    if [ -z "$NODE_COUNT" ]; then
        echo "ERROR: Usage: $0 scale <node-count>"
        exit 1
    fi
    
    echo "Scaling hollow nodes to $NODE_COUNT..."
    kubectl scale deployment hollow-nodes -n "$NAMESPACE" --replicas="$NODE_COUNT"
}

cmd_list() {
    check_kubectl
    
    echo "════════════════════════════════════════════════════════════════"
    echo "Kubemark Status"
    echo "════════════════════════════════════════════════════════════════"
    
    if kubectl get deployment hollow-nodes -n "$NAMESPACE" &>/dev/null; then
        kubectl get deployment hollow-nodes -n "$NAMESPACE"
        echo ""
        kubectl get pods -n "$NAMESPACE" -l name=hollow-node
    else
        echo "No hollow-nodes deployment found"
    fi
}

cmd_help() {
    cat <<EOF
Kubemark Management

Usage: $0 <command> [options]

Commands:
  setup                    Create dedicated kind cluster and setup namespace/secrets
                            (Run this first before creating hollow nodes)
  
  create [NODE_COUNT]      Create hollow nodes
                            NODE_COUNT: Number of nodes (default: 10)
                            Note: Automatically creates kind cluster if needed
                          
  verify                   Verify hollow nodes status
  
  cleanup [DELETE_KIND]    Cleanup hollow nodes
                            DELETE_KIND: Set to 'true' to also delete kind cluster
  
  scale NODE_COUNT         Scale hollow nodes
                            NODE_COUNT: Target number of nodes
                          
  list                     List hollow nodes status
  
  help                     Show this help message

EOF
}

COMMAND="${1:-help}"

case "$COMMAND" in
    setup) cmd_setup ;;
    create) shift; cmd_create "$@" ;;
    verify) cmd_verify ;;
    cleanup) shift; cmd_cleanup "$@" ;;
    scale) shift; cmd_scale "$@" ;;
    list) cmd_list ;;
    help|--help|-h) cmd_help ;;
    *) echo "ERROR: Unknown command: $COMMAND"; cmd_help; exit 1 ;;
esac

